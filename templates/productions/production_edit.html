{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/production/ad_production.css' %}">
{% endblock css %}

{% block content %}
<div class="container-flud ">
  <nav class="navbar navbar-light bg-light shadow-sm p-3 mb-1 bg-light rounded border-bottom-5">
    <span class="navbar-brand mb-0 h1">Edit Production</span>
  </nav>
</div>

<div class="container form-div ">
  <form method="post">
    {% csrf_token %}
    <label for="product">Product:</label><br>
    <select name="product" id="product" class="js-example-basic-single product_input w-50">
      <option value="" selected></option>
      {% for p in Product_Data %}
        <option value="{{ p.id }}" {% if p.id == production.Product_fr.id %} selected {% endif %}>{{ p.Product_Name }}</option>
      {% endfor %}
    </select><br>
    <div class="form-group">
      <label>Raw Materials:</label>
      <div id="raw-materials-container">
        {% for raw_material in raw_materials %}
        <div class="raw-material-row">
          <select name="raw_materials[]" class="js-example-basic-single raw-material-select raw_input custom-select " style="width: 250px;">
            <option value="" selected></option>
            {% for p in RawMaterial_Data %}
              <option value="{{ p.id }}" {% if p.id == raw_material.Raw_Material.id %} selected {% endif %}>{{ p.Product.Product_Name }} - {{ p.Expire_Date }}</option>
            {% endfor %}
          </select>
          <label>Quantity:</label>
          <input type="number" name="raw_materials_measurement[]" class="raw-material-measurement measure_input w-25" required value="{{ raw_material.Measurement }}">
          <button type="button" class="remove-raw-material btn btn-danger">Remove</button>
        </div>
        {% endfor %}
      </div>
      <button type="button" id="add-raw-material" class="btn btn-success mt-2">Add</button><br>
    </div>
    <input type="submit" class="sub-btn btn mt-1 mb-1 btn-primary" value="Update Production">
  </form>
  {% if error_message %}
  <div class="alert alert-danger mt-3" role="alert">
    {{ error_message }}
  </div>
  {% endif %}
</div>
</div>

<script>
$(document).ready(function() {
  const addRawMaterialButton = $('#add-raw-material');
  const rawMaterialsContainer = $('#raw-materials-container');

  addRawMaterialButton.on('click', function() {
    const newRawMaterialDiv = $('<div></div>');
    const rawMaterialSelect = $('<select></select>').addClass('raw-material-select raw_input ').attr('name', 'raw_materials[]');
    const rawMaterialMeasurementInput = $('<input>').attr('type', 'text').attr('name', 'raw_materials_measurement[]').addClass('raw-material-measurement measure_input ');
    const removeRawMaterialButton = $('<button></button>').attr('type', 'button').addClass('remove-raw-material btn btn-danger  mt-2').text('Remove');

    const rawMaterials = $('.raw-material-select');
    const rawMaterialOptions = Array.from(rawMaterials.eq(0).find('option'));

    rawMaterialOptions.forEach(function(option) {
      const newOption = $('<option></option>').val($(option).val()).text($(option).text());
      rawMaterialSelect.append(newOption);
    });

    const selectedProduct = $('#product').val();
    rawMaterialSelect.val(selectedProduct);

    newRawMaterialDiv.append(rawMaterialSelect);
    newRawMaterialDiv.append(rawMaterialMeasurementInput);
    newRawMaterialDiv.append(removeRawMaterialButton);

    rawMaterialsContainer.append(newRawMaterialDiv);
    rawMaterialSelect.select2();
  });

  rawMaterialsContainer.on('click', '.remove-raw-material', function(event) {
    const rawMaterialDiv = $(event.target).parent();
    rawMaterialDiv.remove();
  });
});
</script>
{% endblock %}
